以下は、今回の改修（SSR + Astro Actions + Resend + Cloudflare Turnstile + 顧客JSON連携 + GTM拡張）のセットアップ用マニュアルです。

1. 目的
- SSR を有効化し、Astro Actions で /contact フォーム送信をサーバ処理
- Cloudflare Turnstile で Bot 対策
- Resend 経由でメール送信
- 顧客JSONを読み込んでサイト文言を反映（TTL再読込対応）
- GTM 拡張イベント（click_reserve/click_menu/click_access/form_view/form_submit）対応
- 料金ページを /price へ追加し canonical を /price 優先化

2. 変更差分（主要ファイル）
- SSR/アダプタ/依存
  - [astro.config.mjs](astro.config.mjs)
    - SSR化と Node アダプタ設定 [defineConfig()](astro.config.mjs:29)
  - [package.json](package.json)
    - 依存追加: @astrojs/node, zod, resend
- 環境変数テンプレ
  - [.env.example](.env.example)
    - 追記: PUBLIC_GTM_CONTAINER_ID, PUBLIC_TURNSTILE_SITE_KEY, TURNSTILE_SECRET_KEY, RESEND_API_KEY, SITE_CONTACT_TO_EMAIL, CUSTOMER_CONFIG_PATH, SITE_CONFIG_RELOAD_TTL_SECONDS
- レイアウト（GTM/Turnstile）
  - [src/layouts/BaseLayout.astro](src/layouts/BaseLayout.astro)
    - PUBLIC_GTM_CONTAINER_ID がある時のみ GTM を head/body に挿入
    - Turnstile API スクリプトを body 末尾で読込
- Actions（問い合わせ）
  - [src/actions/index.ts](src/actions/index.ts)
    - Turnstile 検証 [verifyTurnstile()](src/actions/index.ts:5)
    - 送信アクション [contactSubmit()](src/actions/index.ts:20)（zod検証 → Turnstile検証 → Resend送信 → 302リダイレクト）
- ページ
  - [src/pages/contact.astro](src/pages/contact.astro)
    - Actions連携フォーム、Turnstileウィジェット、form_view 発火
  - [src/pages/contact/thanks.astro](src/pages/contact/thanks.astro)
    - form_submit 発火、CTAに data-gtm="reserve"
  - [src/pages/service.astro](src/pages/service.astro)
    - サイトデータから features/CTA を表示 [getSiteData()](src/lib/site-data.ts:65)
  - [src/pages/price.astro](src/pages/price.astro)
    - [pricing.astro](src/pages/pricing.astro) を描画
- SEO/canonical
  - [src/components/common/SEO.astro](src/components/common/SEO.astro)
    - /pricing アクセス時の canonical を /price に補正
- ナビ/クリックイベント属性
  - [src/config/navigation.ts](src/config/navigation.ts)
    - 日本語3件（サービス=/service, 料金=/price, お問い合わせ=/contact）
  - [src/components/layout/Header.astro](src/components/layout/Header.astro)
    - data-gtm を href に応じて付与（menu/reserve/access）
  - [src/components/layout/Footer.astro](src/components/layout/Footer.astro)
    - data-gtm をリンクに付与
- 顧客JSON/ローダ/スキーマ
  - 既定: [src/content/site.default.json](src/content/site.default.json)
  - スキーマ/禁止語: [siteSchema()](src/lib/site-schema.ts:10), [forbidWords()](src/lib/site-schema.ts:3)
  - ローダ/TTL: [readCustomerConfig()](src/lib/site-data.ts:17), [mergeWithDefaults()](src/lib/site-data.ts:33), [getSiteData()](src/lib/site-data.ts:65)
  - ダミー顧客JSON: [customer/sample.customer.json](customer/sample.customer.json)

3. 事前準備
- Node.js 18+ 推奨
- Resend アカウント（テストキー）
- Cloudflare Turnstile（テスト用サイトキー/シークレット）
- GTM コンテナ（任意）

4. 依存インストール
- プロジェクト直下で以下を実行（既に package.json に追加済み）
  - npm i

5. .env 設定（最低限）
- .env をプロジェクト直下に作成して以下を設定（.env.example をコピー）
- 例
  - PUBLIC_GTM_CONTAINER_ID=（任意、指定時のみGTM埋め込み）
  - PUBLIC_TURNSTILE_SITE_KEY=1x00000000000000000000AA
  - TURNSTILE_SECRET_KEY=1x0000000000000000000000000000000AA
  - RESEND_API_KEY=（Resend テストキー）
  - SITE_CONTACT_TO_EMAIL=you@example.com
  - CUSTOMER_CONFIG_PATH=./customer/sample.customer.json
  - SITE_CONFIG_RELOAD_TTL_SECONDS=0

6. Turnstile テストキー（参考）
- Site Key: 1x00000000000000000000AA
- Secret Key: 1x0000000000000000000000000000000AA

7. Resend（テスト）
- From 送信元は [contactSubmit()](src/actions/index.ts:20) 内で onboarding@resend.dev を使用
- SITE_CONTACT_TO_EMAIL へ送信される
- 本番では独自ドメインの検証・From 差し替えを推奨

8. 起動/ビルド
- 開発起動: npm run dev
- 本番ビルド/プレビュー: npm run build && npm run preview

9. 表示/スモークテスト
- 主要URL（HTTP 200）
  - /service, /price, /contact, /contact/thanks
- GTM 埋め込み
  - PUBLIC_GTM_CONTAINER_ID 設定時のみ head/body に GTM が入る（[src/layouts/BaseLayout.astro](src/layouts/BaseLayout.astro)）
- フォーム
  - /contact で Turnstile ウィジェットが表示
  - 通常送信フロー
    - 入力 → Turnstile 成功 → [contactSubmit()](src/actions/index.ts:20) → /contact/thanks へリダイレクト
  - エラー時は送信不可（Turnstile 失敗等）
- dataLayer イベント
  - /contact 表示時: form_view
  - /contact/thanks 表示時: form_submit
  - 検証方法: DevTools Console で window.dataLayer を確認
- クリックイベント（GTM）
  - ヘッダー/フッターのリンクに data-gtm が付与（menu/reserve/access）

10. 顧客JSONの編集/反映
- 既定（初期文言）: [src/content/site.default.json](src/content/site.default.json)
- ダミー顧客JSON: [customer/sample.customer.json](customer/sample.customer.json)
- 読み込みルール
  - [CUSTOMER_CONFIG_PATH](.env.example) で顧客JSONの場所を指定（ローカルパス or URL）
  - [getSiteData()](src/lib/site-data.ts:65) が既定 + 顧客JSONをディープマージ（[mergeWithDefaults()](src/lib/site-data.ts:33)）
  - [SITE_CONFIG_RELOAD_TTL_SECONDS](.env.example)
    - 0: 毎リクエスト再読込（開発向け）
    - 未設定/負値: 起動時のみ読込（本番向け）
- スキーマ/禁止語
  - 構造/型を [siteSchema()](src/lib/site-schema.ts:10) で検証
  - 禁止語（治療/改善/効果/医療）は [forbidWords()](src/lib/site-schema.ts:3) の簡易検出で置換・サニタイズ（ログ警告）

11. 料金ページの canonical
- /pricing にアクセスしても [SEO.astro](src/components/common/SEO.astro:63) の補正で canonical は /price を優先

12. ナビゲーションと data-gtm
- ヘッダー
  - [src/config/navigation.ts](src/config/navigation.ts)
  - [src/components/layout/Header.astro](src/components/layout/Header.astro)（hrefに応じて data-gtm 付与）
- フッター
  - [src/components/layout/Footer.astro](src/components/layout/Footer.astro)（リンクに data-gtm 付与）

13. 既知の注意/トラブルシュート
- 初回セットアップ時に VSCode が型エラー（astro:actions / node 型等）を表示する場合
  - npm i 実行後に解消されることがあります
  - 必要に応じて @types/node の導入を検討
- Resend 送信が届かない場合
  - テストキー/送信元/受信側のスパム判定を確認
- Turnstile が失敗する場合
  - テストキーの設定とネットワーク（CSP/ファイアウォール）を確認

14. 実装した主な関数/ポイント（参照）
- SSR/アダプタ: [defineConfig()](astro.config.mjs:29)
- アクション（問い合わせ送信）: [contactSubmit()](src/actions/index.ts:20)
- Turnstile 検証: [verifyTurnstile()](src/actions/index.ts:5)
- サイトデータ取得: [getSiteData()](src/lib/site-data.ts:65)
- 顧客JSONマージ: [mergeWithDefaults()](src/lib/site-data.ts:33)
- スキーマ: [siteSchema()](src/lib/site-schema.ts:10)
- 禁止語チェック: [forbidWords()](src/lib/site-schema.ts:3)

15. テスト用ダミー顧客JSON
- 配置: [customer/sample.customer.json](customer/sample.customer.json)
- 反映方法
  - .env の CUSTOMER_CONFIG_PATH=./customer/sample.customer.json（既定値）
  - /service などで文言が反映されることを確認