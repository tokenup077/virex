---
/**
 * ForgotPasswordForm - Password reset request form
 *
 * @description
 * A form for requesting password reset. Includes email validation,
 * loading states, and success/error feedback. Runs in demo mode
 * when no action URL is provided.
 *
 * @example Demo mode (no backend)
 * ```astro
 * <ForgotPasswordForm />
 * ```
 *
 * @example With custom endpoint
 * ```astro
 * <ForgotPasswordForm action="https://api.example.com/forgot-password" />
 * ```
 */

interface Props {
  /** Form action URL - leave empty for demo mode */
  action?: string;
  /** HTTP method for form submission */
  method?: 'POST' | 'GET';
}

const {
  action = '',
  method = 'POST',
} = Astro.props;
---

<form
  id="forgot-password-form"
  action={action}
  method={method}
  class="space-y-6"
  novalidate
>
  <!-- Honeypot field for spam protection -->
  <div class="hidden" aria-hidden="true">
    <label>
      Don't fill this out if you're human:
      <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" />
    </label>
  </div>

  <!-- Email field -->
  <div>
    <label for="forgot-email" class="block text-sm font-medium text-text mb-2">
      Email address
    </label>
    <input
      type="email"
      id="forgot-email"
      name="email"
      required
      autocomplete="email"
      class="w-full px-4 py-3 rounded-md border border-border bg-background text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
      placeholder="you@example.com"
    />
    <p class="mt-1 text-sm text-red-500 hidden" data-error="forgot-email"></p>
  </div>

  <!-- Form status messages -->
  <div id="forgot-form-status" class="hidden">
    <div
      id="forgot-form-success"
      class="hidden p-4 rounded-md bg-green-100 dark:bg-green-950 border border-green-300 dark:border-green-800"
    >
      <p class="text-green-900 dark:text-green-100 font-medium">
        Check your email
      </p>
      <p class="text-green-800 dark:text-green-300 text-sm mt-1">
        If an account exists with that email, we've sent password reset instructions.
      </p>
    </div>
    <div
      id="forgot-form-error"
      class="hidden p-4 rounded-md bg-red-100 dark:bg-red-950 border border-red-300 dark:border-red-800"
    >
      <p class="text-red-900 dark:text-red-100 font-medium">
        Something went wrong
      </p>
      <p class="text-red-800 dark:text-red-300 text-sm mt-1">
        Please try again or contact support if the problem persists.
      </p>
    </div>
  </div>

  <!-- Submit button -->
  <button
    type="submit"
    id="forgot-submit-button"
    class="w-full cursor-pointer px-6 py-3 rounded-md bg-primary text-white font-medium hover:bg-primary-dark transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed"
  >
    <span id="forgot-button-text">Send reset link</span>
    <span id="forgot-button-loading" class="hidden">
      <svg
        class="animate-spin inline-block w-5 h-5 mr-2"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      Sending...
    </span>
  </button>
</form>

<script>
  const form = document.getElementById('forgot-password-form') as HTMLFormElement;
  const submitButton = document.getElementById('forgot-submit-button') as HTMLButtonElement;
  const buttonText = document.getElementById('forgot-button-text');
  const buttonLoading = document.getElementById('forgot-button-loading');
  const formStatus = document.getElementById('forgot-form-status');
  const formSuccess = document.getElementById('forgot-form-success');
  const formError = document.getElementById('forgot-form-error');
  const emailInput = document.getElementById('forgot-email') as HTMLInputElement;

  // Validation
  function validateEmail(value: string): string | null {
    if (!value.trim()) return 'Email is required';
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(value)) return 'Please enter a valid email address';
    return null;
  }

  // Show/hide error message
  function showError(message: string | null) {
    const errorEl = document.querySelector('[data-error="forgot-email"]');

    if (errorEl && emailInput) {
      if (message) {
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
        emailInput.classList.add('border-red-500');
        emailInput.classList.remove('border-border');
      } else {
        errorEl.classList.add('hidden');
        emailInput.classList.remove('border-red-500');
        emailInput.classList.add('border-border');
      }
    }
  }

  // Validate field
  function validateField(): boolean {
    const error = validateEmail(emailInput.value);
    showError(error);
    return !error;
  }

  // Real-time validation
  emailInput?.addEventListener('blur', validateField);
  emailInput?.addEventListener('input', () => {
    const errorEl = document.querySelector('[data-error="forgot-email"]');
    if (errorEl && !errorEl.classList.contains('hidden')) {
      validateField();
    }
  });

  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Hide previous status messages
    formStatus?.classList.add('hidden');
    formSuccess?.classList.add('hidden');
    formError?.classList.add('hidden');

    // Validate form
    if (!validateField()) {
      emailInput?.focus();
      return;
    }

    // Show loading state
    submitButton.disabled = true;
    buttonText?.classList.add('hidden');
    buttonLoading?.classList.remove('hidden');

    const formData = new FormData(form);
    const action = form.action;

    try {
      // If no action URL, simulate success (demo mode)
      if (!action || action === window.location.href) {
        await new Promise((resolve) => setTimeout(resolve, 1500));
        showSuccess();
        return;
      }

      // Submit to actual endpoint
      const response = await fetch(action, {
        method: form.method || 'POST',
        body: formData,
        headers: {
          Accept: 'application/json',
        },
      });

      if (response.ok) {
        showSuccess();
      } else {
        showErrorState();
      }
    } catch {
      showErrorState();
    }
  });

  function showSuccess() {
    formStatus?.classList.remove('hidden');
    formSuccess?.classList.remove('hidden');
    form.reset();
    resetButtonState();
  }

  function showErrorState() {
    formStatus?.classList.remove('hidden');
    formError?.classList.remove('hidden');
    resetButtonState();
  }

  function resetButtonState() {
    submitButton.disabled = false;
    buttonText?.classList.remove('hidden');
    buttonLoading?.classList.add('hidden');
  }
</script>
