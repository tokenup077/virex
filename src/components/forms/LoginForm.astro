---
/**
 * LoginForm - Login form with validation and multiple backend support
 *
 * @description
 * A fully-featured login form with client-side validation, loading states,
 * and success/error feedback. Supports Netlify Identity, custom endpoints,
 * and runs in demo mode (simulates success) when no action URL is provided.
 *
 * @example Demo mode (no backend)
 * ```astro
 * <LoginForm />
 * ```
 *
 * @example Netlify Identity
 * ```astro
 * <LoginForm netlify />
 * ```
 *
 * @example Custom endpoint
 * ```astro
 * <LoginForm action="https://api.example.com/login" method="POST" />
 * ```
 */

interface Props {
  /** Form action URL - leave empty for demo mode */
  action?: string;
  /** HTTP method for form submission */
  method?: 'POST' | 'GET';
  /** Enable Netlify Identity integration */
  netlify?: boolean;
  /** Redirect URL after successful login */
  redirectUrl?: string;
}

const {
  action = '',
  method = 'POST',
  netlify = false,
  redirectUrl = '/',
} = Astro.props;
---

<form
  id="login-form"
  action={action}
  method={method}
  class="space-y-6"
  data-netlify={netlify ? 'true' : undefined}
  data-redirect={redirectUrl}
  novalidate
>
  <!-- Honeypot field for spam protection -->
  <div class="hidden" aria-hidden="true">
    <label>
      Don't fill this out if you're human:
      <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" />
    </label>
  </div>

  <!-- Email field -->
  <div>
    <label for="email" class="block text-sm font-medium text-text mb-2">
      Email address
    </label>
    <input
      type="email"
      id="email"
      name="email"
      required
      autocomplete="email"
      class="w-full px-4 py-3 rounded-md border border-border bg-background text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
      placeholder="you@example.com"
    />
    <p class="mt-1 text-sm text-red-500 hidden" data-error="email"></p>
  </div>

  <!-- Password field -->
  <div>
    <label for="password" class="block text-sm font-medium text-text mb-2">
      Password
    </label>
    <input
      type="password"
      id="password"
      name="password"
      required
      autocomplete="current-password"
      class="w-full px-4 py-3 rounded-md border border-border bg-background text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
      placeholder="••••••••"
    />
    <p class="mt-1 text-sm text-red-500 hidden" data-error="password"></p>
  </div>

  <!-- Remember me and Forgot password -->
  <div class="flex items-center justify-between">
    <div class="flex items-center">
      <input
        type="checkbox"
        id="rememberMe"
        name="rememberMe"
        class="h-4 w-4 rounded border-border text-primary focus:ring-primary focus:ring-offset-background"
      />
      <label for="rememberMe" class="ml-2 text-sm text-text-muted">
        Remember me
      </label>
    </div>
    <a
      href="/forgot-password"
      class="text-sm font-medium text-primary hover:text-primary-dark transition-colors focus:outline-none focus:underline"
    >
      Forgot password?
    </a>
  </div>

  <!-- Form status messages -->
  <div id="login-form-status" class="hidden">
    <div
      id="login-form-success"
      class="hidden p-4 rounded-md bg-green-100 dark:bg-green-950 border border-green-300 dark:border-green-800"
    >
      <p class="text-green-900 dark:text-green-100 font-medium">
        Login successful!
      </p>
      <p class="text-green-800 dark:text-green-300 text-sm mt-1">
        Redirecting you now...
      </p>
    </div>
    <div
      id="login-form-error"
      class="hidden p-4 rounded-md bg-red-100 dark:bg-red-950 border border-red-300 dark:border-red-800"
    >
      <p class="text-red-900 dark:text-red-100 font-medium">Login failed</p>
      <p class="text-red-800 dark:text-red-300 text-sm mt-1">
        Please check your credentials and try again.
      </p>
    </div>
  </div>

  <!-- Submit button -->
  <button
    type="submit"
    id="login-submit-button"
    class="w-full cursor-pointer px-6 py-3 rounded-md bg-primary text-white font-medium hover:bg-primary-dark transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background disabled:opacity-50 disabled:cursor-not-allowed"
  >
    <span id="login-button-text">Sign in</span>
    <span id="login-button-loading" class="hidden">
      <svg
        class="animate-spin inline-block w-5 h-5 mr-2"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      Signing in...
    </span>
  </button>
</form>

<script>
  const form = document.getElementById('login-form') as HTMLFormElement;
  const submitButton = document.getElementById(
    'login-submit-button'
  ) as HTMLButtonElement;
  const buttonText = document.getElementById('login-button-text');
  const buttonLoading = document.getElementById('login-button-loading');
  const formStatus = document.getElementById('login-form-status');
  const formSuccess = document.getElementById('login-form-success');
  const formError = document.getElementById('login-form-error');

  // Validation rules
  const validationRules: Record<string, (value: string) => string | null> = {
    email: (value) => {
      if (!value.trim()) return 'Email is required';
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) return 'Please enter a valid email address';
      return null;
    },
    password: (value) => {
      if (!value) return 'Password is required';
      return null;
    },
  };

  // Show/hide error message
  function showError(fieldName: string, message: string | null) {
    const errorEl = document.querySelector(
      `#login-form [data-error="${fieldName}"]`
    );
    const inputEl = document.getElementById(fieldName);

    if (errorEl && inputEl) {
      if (message) {
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
        inputEl.classList.add('border-red-500');
        inputEl.classList.remove('border-border');
      } else {
        errorEl.classList.add('hidden');
        inputEl.classList.remove('border-red-500');
        inputEl.classList.add('border-border');
      }
    }
  }

  // Validate single field
  function validateField(fieldName: string): boolean {
    const input = form.elements.namedItem(fieldName) as HTMLInputElement;
    if (!input || !validationRules[fieldName]) return true;

    const error = validationRules[fieldName](input.value);
    showError(fieldName, error);
    return !error;
  }

  // Validate all fields
  function validateForm(): boolean {
    let isValid = true;
    for (const fieldName of Object.keys(validationRules)) {
      if (!validateField(fieldName)) {
        isValid = false;
      }
    }
    return isValid;
  }

  // Real-time validation on blur
  for (const fieldName of Object.keys(validationRules)) {
    const input = form.elements.namedItem(fieldName) as HTMLInputElement | null;
    if (input && 'addEventListener' in input) {
      input.addEventListener('blur', () => validateField(fieldName));
      input.addEventListener('input', () => {
        // Clear error on input if field was previously invalid
        const errorEl = document.querySelector(
          `#login-form [data-error="${fieldName}"]`
        );
        if (errorEl && !errorEl.classList.contains('hidden')) {
          validateField(fieldName);
        }
      });
    }
  }

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Hide previous status messages
    formStatus?.classList.add('hidden');
    formSuccess?.classList.add('hidden');
    formError?.classList.add('hidden');

    // Validate form
    if (!validateForm()) {
      // Focus first invalid field
      const firstError = form.querySelector(
        '.border-red-500'
      ) as HTMLElement;
      firstError?.focus();
      return;
    }

    // Show loading state
    submitButton.disabled = true;
    buttonText?.classList.add('hidden');
    buttonLoading?.classList.remove('hidden');

    const formData = new FormData(form);
    const action = form.action;

    try {
      // If no action URL, simulate success (demo mode)
      if (!action || action === window.location.href) {
        await new Promise((resolve) => setTimeout(resolve, 1500));
        showSuccess();
        return;
      }

      // Submit to actual endpoint
      const response = await fetch(action, {
        method: form.method || 'POST',
        body: formData,
        headers: {
          Accept: 'application/json',
        },
      });

      if (response.ok) {
        showSuccess();
      } else {
        showErrorState();
      }
    } catch {
      showErrorState();
    }
  });

  function showSuccess() {
    formStatus?.classList.remove('hidden');
    formSuccess?.classList.remove('hidden');
    resetButtonState();

    // Redirect after showing success message
    const redirectUrl = form.dataset.redirect || '/';
    setTimeout(() => {
      window.location.href = redirectUrl;
    }, 1500);
  }

  function showErrorState() {
    formStatus?.classList.remove('hidden');
    formError?.classList.remove('hidden');
    resetButtonState();
  }

  function resetButtonState() {
    submitButton.disabled = false;
    buttonText?.classList.remove('hidden');
    buttonLoading?.classList.add('hidden');
  }
</script>
